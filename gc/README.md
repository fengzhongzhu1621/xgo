# GC

## 1. 简介
Go语言的垃圾回收（GC）是一种自动化的内存管理机制，它通过标记未使用的对象并释放它们占用的内存来防止内存泄漏。
自Go 1.0版本发布以来，Go的垃圾回收经历了显著的优化，从最初的简单标记-清除算法，发展到Go 1.5版本引入的并发标记和并发清除，极大地减少了GC的暂停时间。


## 2. 概念

* 对象的生命周期：每个对象都有一个从分配到回收的生命周期。
* 根集：垃圾回收从一组根对象开始，这些通常是全局变量或寄存器中的指针。
* 可达性分析：垃圾回收器通过从根集开始，递归地访问所有可达的对象，来确定哪些对象仍然在使用中。
* 标记-清除算法：Go的垃圾回收器使用标记-清除算法来识别和回收垃圾对象。这个过程包括两个主要阶段：
  - 标记阶段：垃圾回收器遍历所有可达对象，并标记它们。
  - 清除阶段：回收器再次遍历堆内存，清除所有未被标记的对象。
* 并发执行：Go的垃圾回收器可以与程序的其他部分并发运行，这意味着垃圾回收的大部分工作可以在后台进行，而不会阻塞程序的执行。
* 暂停（Stop-the-World）：尽管垃圾回收主要并发执行，但在某些时刻（如标记的开始和结束），垃圾回收器可能需要暂停程序的执行，以确保标记的准确性。
* 性能调优：Go提供了一些环境变量和调优选项，允许开发者根据应用的特定需求调整垃圾回收的性能。

## 3. 垃圾回收算法

### 3.1 标记-清除（Mark-Sweep）

分为两个阶段：

* 标记阶段：从根对象开始，递归地标记所有可达的对象。
* 清除阶段：遍历堆内存，清除所有未被标记的对象。

**优点**：算法简单，实现容易。
**缺点**：效率不高，因为清除阶段需要遍历整个堆；且会产生内存碎片。

## 3.2 标记-清除-整理（Mark-Sweep-Compact）

* 为了解决标记-清除算法的内存碎片问题，引入了整理阶段：

整理阶段：在清除未标记对象后，将所有存活的对象向前移动，紧凑地排列在堆的一侧。

**优点**：减少了内存碎片，提高了内存的利用率。
**缺点**：整理阶段需要移动对象，可能会增加CPU的负载。

## 3.3 三色标记法（Tri-color Marking）
三色标记法是一种并发垃圾回收算法，它使用三种颜色来标记对象：

* 黑色：表示对象已经被标记，且它的所有引用都已经被检查过。
* 灰色：表示对象已经被标记，但至少有一个引用还没有被检查。
* 白色：表示对象尚未被标记

**清除阶段**：清除所有未被标记（白色）的对象
**整理阶段**：可选，将所有黑色对象移动到内存的一侧，减少内存碎片

**优点**：可以与程序的执行并发运行，减少暂停时间。 
**缺点**：实现复杂，需要处理并发标记中的竞态条件。

## 3.4 并发标记-清除（Concurrent Mark-Sweep）
结合了三色标记法，并发地执行标记和清除阶段：

* 并发标记阶段：与程序并发运行，标记所有可达对象。
* 并发清除阶段：在适当的时候，停止程序的执行，快速清除所有未标记的对象。

