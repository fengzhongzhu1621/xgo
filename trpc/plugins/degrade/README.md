# tRPC-Go [degrade] 熔断保护插件

## degrade 插件使用介绍

* degrade 插件主要功能：

1. 周期检测获取系统负载情况
2. 根据 CPUidle，内存使用率，负载（主要 load5）来设置阈值，达到阈值触发熔断保护，抛弃一定百分比的随机流量
3. 可限制最大并发请求数，应对超短时突发流量，和上述互为补充


## 使用说明

### load5 参数值设置参考（常规机器/容器）

### 当获取 load5 不准时可以将 load 的阈值设置为 999

由于 5 分钟 load 可能存在对系统负载不敏感的地方，因此根据不断的长期研究和实践，结合在实际业务中的使用情况，建议使用如下配置方法

```go
    load5 := int ((2 * x + 3 * y) / 5)
```

其中 x 为空闲期平均 1 分钟负载，y 为核心数（一般负载超过核心数认为高负载）
理论为 连续 5 分钟周期，3 分钟高负载即触发 熔断！

假如平台容器的 load 指标不能准确获取，需要设置一个大值以跳过这个指标，例如：10000

例如：
使用 uptime 命令：

```go
[xxx@xxx ~]$ uptime
 14:55:45 up 121 days, 15:55,  1 user,  load average: 0.16, 0.26, 0.23
load average: 0.16(1min), 0.26(5min), 0.23(15min)

比如 load average: 1min 负载为 0.16, 核心数为 2, 则 load 5min 配置 load5 参考值设置为 1.264

(0.16*2+3*2)/5=(0.32+6)/5=6.32/5=1.264

核心数计算：grep -c 'model name' /proc/cpuinfo

```
