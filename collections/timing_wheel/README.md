# 时间轮
时间轮是一种高效利用线程资源进行批量化调度的一种调度模型。
通过把大批量的调度任务全部绑定到同一个调度器上，使用这一个调度器来进行所有任务的管理、触发、以及运行。
时间轮的模型能够高效管理各种延时任务、周期任务、通知任务。
时间轮是以时间作为刻度组成的一个环形队列，所以叫做时间轮。时间轮的时间格的个数是固定的。

# 单层时间轮
有16个时间格（槽），假设每个时间格的单位是1s，那么整个时间轮走完一圈需要16s，每秒钟（即时间格的单位，也可以为1ms、1min、1h等）指针会沿着顺时针方向转动一格，通过指针移动，来获得每个时间格中的任务列表，然后遍历并执行这一个时间格内的双向链表的每个任务，依此循环。

# Kafka时间轮实现
## 组成
Kafka中的时间轮（TimingWheel） 是一个存储定时任务的环形队列，底层采用数组实现，数组内的每个元素可以存放一个定时任务列表（TimerTaskList）。TimerTaskList是一个环形的双向链表，链表中的每一项表示的都是定时任务项（TimerTaskEntry），其中封装了真正的定时任务（TimerTask）。

时间轮由多个时间格组成，每个时间格代表当前时间轮的基本时间跨度（tickMs）。时间轮的时间格的个数（wheelSize）是固定的，整个时间轮的时间跨=跨度（interval=wheelSize*tickMS）。

时间轮还有一个表盘指针（currentTime），用来表示时间轮当前所处的时间，表盘指针可以将整个时间轮划分为到期部分和未到期部分，表盘指针当前指向的时间格也属于到期部分，表示刚好到期，需要处理此时间格所对应的TimerTaskList中的所有任务。

## 原理
若时间轮的 tickMs 为 1ms且 wheelSize 等于20，那么可以计算得出总体时间跨度 interval 为 20ms。

初始情况下表盘指针 currentTime 指向时间格0，此时有一个延时为2ms的任务插进来会存放到时间格为2的TimerTaskList中。随着时间不断推移，指针currentTime不断向前推进，过了2ms之后，当到达时间格2时，就需要将时间格2对应的TimerTaskList中的任务进行相应的到期操作。此时若又有一个延时为8ms的任务插进来，则会存放到时间格为10中。

若延时的时长大于时间轮的总体时间跨度20ms，那该怎么办，不能无限扩容wheelSize的大小，kafka为此引入了时间轮的概念，当任务的到期时间超过了当前时间轮所表示的时间范围时，就会尝试添加到上层时间轮中。

